name: CI

on:
  push:
    branches:
      - gay
      - slave
      - master
    tags: ['*']
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ startsWith(github.ref, 'refs/pull/') }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SLAVE: Sequential testing - one job at a time, verify SPI step by step
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-slave:
    name: Slave (Sequential) - Julia ${{ matrix.version }}
    if: github.ref == 'refs/heads/slave'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      actions: write
      contents: read
    strategy:
      fail-fast: true
      max-parallel: 1  # Sequential execution
      matrix:
        version:
          - '1.10'
          - '1.11'
    steps:
      - uses: actions/checkout@v4
      - uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.version }}
      - uses: julia-actions/cache@v2
      - uses: julia-actions/julia-buildpkg@v1
      
      - name: Run SPI tests with various seeds (sequential)
        run: |
          julia --project=. -e '
            using Pkg
            Pkg.instantiate()
            
            using Gay
            using Gay: ka_colors, xor_fingerprint, hash_color
            using KernelAbstractions: CPU
            
            println("â•" ^ 60)
            println("SLAVE MODE: Sequential SPI Verification")
            println("â•" ^ 60)
            
            test_seeds = [
                (0, "zero"),
                (1, "minimal"),
                (42, "classic"),
                (1337, "leetspeak"),
                (42069, "gallery"),
                (0x6761795f636f6c6f, "GAY_SEED"),
                (0x78656e6f66656d21, "XF_SEED"),
            ]
            
            n = 10000
            all_pass = true
            
            for (seed, name) in test_seeds
                print("  Testing seed=$name ($seed)... ")
                
                # Sequential reference
                ref = zeros(Float32, n, 3)
                for i in 1:n
                    r, g, b = hash_color(UInt64(seed), UInt64(i))
                    ref[i, 1] = r
                    ref[i, 2] = g
                    ref[i, 3] = b
                end
                ref_fp = xor_fingerprint(ref)
                
                # KernelAbstractions
                ka = ka_colors(n, seed)
                ka_fp = xor_fingerprint(ka)
                
                if ref_fp == ka_fp
                    println("âœ“ PASS (0x$(string(ref_fp, base=16, pad=8)))")
                else
                    println("âœ— FAIL (ref=0x$(string(ref_fp, base=16, pad=8)), ka=0x$(string(ka_fp, base=16, pad=8)))")
                    global all_pass = false
                end
            end
            
            println()
            if all_pass
                println("ALL SEEDS VERIFIED âœ“")
            else
                error("SPI verification failed!")
            end
          '
      
      - uses: julia-actions/julia-runtest@v1
      - uses: julia-actions/julia-processcoverage@v1
      - uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # MASTER: Maximally parallel testing - all jobs at once
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-master:
    name: Master (Parallel) - Julia ${{ matrix.version }} - ${{ matrix.os }}
    if: github.ref == 'refs/heads/master'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    permissions:
      actions: write
      contents: read
    strategy:
      fail-fast: false  # Run all even if some fail
      max-parallel: 10  # Maximum parallelism
      matrix:
        version:
          - '1.10'
          - '1.11'
          - 'nightly'
        os:
          - ubuntu-latest
          - macOS-latest
        include:
          - os: ubuntu-latest
            arch: x64
          - os: macOS-latest
            arch: aarch64
        exclude:
          - os: macOS-latest
            version: 'nightly'
          - os: ubuntu-latest
            version: 'nightly'
    steps:
      - uses: actions/checkout@v4
      - uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.version }}
          arch: ${{ matrix.arch }}
      - uses: julia-actions/cache@v2
      - uses: julia-actions/julia-buildpkg@v1
      
      - name: Run parallel SPI verification
        run: |
          julia --project=. --threads=auto -e '
            using Pkg
            Pkg.instantiate()
            
            using Gay
            using Gay: ka_colors, xor_fingerprint
            
            println("â•" ^ 60)
            println("MASTER MODE: Parallel SPI Verification")
            println("Threads: $(Threads.nthreads())")
            println("â•" ^ 60)
            
            # Generate fingerprints in parallel across seeds
            seeds = [0, 1, 42, 1337, 42069, 0x6761795f636f6c6f, 0x78656e6f66656d21]
            n = 100000
            
            fingerprints = Vector{UInt32}(undef, length(seeds))
            
            Threads.@threads for i in eachindex(seeds)
                colors = ka_colors(n, seeds[i])
                fingerprints[i] = xor_fingerprint(colors)
            end
            
            # Verify reproducibility
            fingerprints2 = Vector{UInt32}(undef, length(seeds))
            Threads.@threads for i in eachindex(seeds)
                colors = ka_colors(n, seeds[i])
                fingerprints2[i] = xor_fingerprint(colors)
            end
            
            all_match = fingerprints == fingerprints2
            
            for i in eachindex(seeds)
                status = fingerprints[i] == fingerprints2[i] ? "âœ“" : "âœ—"
                println("  seed=$(seeds[i]): 0x$(string(fingerprints[i], base=16, pad=8)) $status")
            end
            
            println()
            if all_match
                println("PARALLEL SPI VERIFIED âœ“")
            else
                error("Parallel SPI verification failed!")
            end
          '
      
      - uses: julia-actions/julia-runtest@v1
      - uses: julia-actions/julia-processcoverage@v1
      - uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # GAY: Observer mode - no tests, just watch and report
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  observe-gay:
    name: Gay (Observer) ğŸ³ï¸â€ğŸŒˆ
    if: github.ref == 'refs/heads/gay'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Observe without testing
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  GAY MODE: Observer ğŸ³ï¸â€ğŸŒˆ"
          echo "  No tests run - observing only"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo ""
          echo "Files changed:"
          git diff --name-only HEAD~1 || echo "(first commit)"
          echo ""
          echo "Gay.jl observes. Gay.jl remembers. ğŸŒˆ"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PR / Tags: Standard testing
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-pr:
    name: PR/Tag - Julia ${{ matrix.version }} - ${{ matrix.os }}
    if: github.event_name == 'pull_request' || startsWith(github.ref, 'refs/tags/')
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    permissions:
      actions: write
      contents: read
    strategy:
      fail-fast: false
      matrix:
        version:
          - '1.10'
          - '1.11'
        os:
          - ubuntu-latest
          - macOS-latest
        include:
          - os: ubuntu-latest
            arch: x64
          - os: macOS-latest
            arch: aarch64
    steps:
      - uses: actions/checkout@v4
      - uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.version }}
          arch: ${{ matrix.arch }}
      - uses: julia-actions/cache@v2
      - uses: julia-actions/julia-buildpkg@v1
      - uses: julia-actions/julia-runtest@v1
      - uses: julia-actions/julia-processcoverage@v1
      - uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Documentation (runs on all branches)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/gay'  # Skip docs on gay branch
    permissions:
      actions: write
      contents: write
      statuses: write
      pages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: julia-actions/setup-julia@v2
        with:
          version: '1.10'
      - uses: julia-actions/cache@v2
      - name: Configure doc environment
        shell: julia --project=docs --color=yes {0}
        run: |
          using Pkg
          Pkg.develop(PackageSpec(path=pwd()))
          Pkg.instantiate()
      - name: Build and deploy docs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DOCUMENTER_KEY: ${{ secrets.DOCUMENTER_KEY }}
        run: julia --project=docs docs/make.jl
      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/build/
