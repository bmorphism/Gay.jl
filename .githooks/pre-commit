#!/usr/bin/env julia
#
# Git pre-commit hook: Verify Strong Parallelism Invariance (SPI)
#
# Ensures color generation is deterministic before allowing commits.
# Cherry-pick this hook for SPI guarantees in any project using Gay.jl.
#
# Installation:
#   git config core.hooksPath .githooks
#   chmod +x .githooks/pre-commit
#
# Or symlink:
#   ln -sf ../../.githooks/pre-commit .git/hooks/pre-commit

using Pkg
Pkg.activate(joinpath(@__DIR__, ".."))

try
    using Gay
catch
    @warn "Gay.jl not available, skipping SPI verification"
    exit(0)
end

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Configuration
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SEED = 42
const N_STEPS = 69                    # Default verification steps (nice)
const N_COLORS = 10_000
const EXPECTED_FINGERPRINT = nothing  # Set to lock fingerprint across commits

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# XOR Fingerprint for color verification
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function xor_fingerprint(colors::AbstractMatrix{Float32})
    fp = UInt32(0)
    for i in 1:size(colors, 1)
        r = reinterpret(UInt32, colors[i, 1])
        g = reinterpret(UInt32, colors[i, 2])
        b = reinterpret(UInt32, colors[i, 3])
        fp = xor(fp, r, g, b)
    end
    fp
end

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Interaction-by-Interaction Verification (69 steps)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function verify_interactions(n_steps::Int=N_STEPS)
    println("  Interaction-by-interaction ($n_steps steps)...")
    
    all_match = true
    mismatches = Int[]
    
    for step in 1:n_steps
        # Generate single color at this step from two independent runs
        c1 = ka_colors(1, SEED + step - 1)
        c2 = ka_colors(1, SEED + step - 1)
        
        if c1 != c2
            push!(mismatches, step)
            all_match = false
        end
    end
    
    if all_match
        println("    âœ“ All $n_steps interactions match")
    else
        println("    âŒ Mismatches at steps: $(mismatches)")
    end
    
    return all_match
end

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SPI Verification
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function verify_spi()
    println("ğŸ³ï¸â€ğŸŒˆ Gay.jl SPI Pre-Commit Hook")
    println("=" ^ 50)
    
    # 1. Sequential generation
    print("  Sequential generation... ")
    seq_colors = ka_colors(N_COLORS, SEED)
    seq_fp = xor_fingerprint(seq_colors)
    println("âœ“ ($(string(seq_fp, base=16)))")
    
    # 2. Parallel generation (different order)
    print("  Parallel generation...   ")
    par_colors = ka_colors(N_COLORS, SEED)
    par_fp = xor_fingerprint(par_colors)
    println("âœ“ ($(string(par_fp, base=16)))")
    
    # 3. Verify match
    if seq_fp != par_fp
        println()
        println("âŒ SPI VIOLATION DETECTED!")
        println("   Sequential fingerprint: $(string(seq_fp, base=16))")
        println("   Parallel fingerprint:   $(string(par_fp, base=16))")
        println()
        println("   Colors are not deterministic. Commit blocked.")
        return false
    end
    
    # 4. Interaction-by-interaction verification (69 steps)
    if !verify_interactions(N_STEPS)
        return false
    end
    
    # 5. Check expected fingerprint (if locked)
    if EXPECTED_FINGERPRINT !== nothing && seq_fp != EXPECTED_FINGERPRINT
        println()
        println("âŒ FINGERPRINT MISMATCH!")
        println("   Expected: $(string(EXPECTED_FINGERPRINT, base=16))")
        println("   Got:      $(string(seq_fp, base=16))")
        println()
        println("   Color algorithm may have changed. Update EXPECTED_FINGERPRINT if intentional.")
        return false
    end
    
    # 6. Quick billion-scale sanity check
    print("  Billion-scale check...   ")
    sums = ka_color_sums(1_000_000, SEED; chunk_size=10_000)
    expected_sum = 1_000_000 / 2
    tolerance = expected_sum * 0.1
    
    for (i, name) in enumerate(["R", "G", "B"])
        if abs(sums[i] - expected_sum) > tolerance
            println()
            println("âŒ Distribution anomaly in $name channel")
            println("   Expected: ~$(expected_sum)")
            println("   Got:      $(sums[i])")
            return false
        end
    end
    println("âœ“")
    
    println("=" ^ 50)
    println("âœ“ All SPI invariants verified. Commit allowed.")
    println()
    
    return true
end

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Main
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if !verify_spi()
    exit(1)
end
