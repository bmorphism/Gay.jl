#!/usr/bin/env julia
#
# Extended SPI Verification: 1069 seconds of continuous color matching
#
# Runs for ~18 minutes, verifying colors match interaction-by-interaction.
# Use before releases or after major changes.
#
# Usage:
#   julia .githooks/verify-1069
#   ./.githooks/verify-1069  # if executable

using Pkg
Pkg.activate(joinpath(@__DIR__, ".."))

using Gay
using Dates

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Configuration
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const DURATION_SECONDS = 1069         # ~17.8 minutes (nice number)
const SEED = 42
const BATCH_SIZE = 1000               # Colors per batch
const REPORT_INTERVAL = 69            # Report every 69 seconds

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# XOR Fingerprint
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function xor_fingerprint(colors::AbstractMatrix{Float32})
    fp = UInt32(0)
    for i in 1:size(colors, 1)
        r = reinterpret(UInt32, colors[i, 1])
        g = reinterpret(UInt32, colors[i, 2])
        b = reinterpret(UInt32, colors[i, 3])
        fp = xor(fp, r, g, b)
    end
    fp
end

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Extended Verification
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function verify_extended()
    println()
    println("ğŸ³ï¸â€ğŸŒˆ Gay.jl Extended SPI Verification")
    println("â•" ^ 60)
    println("  Duration:       $(DURATION_SECONDS) seconds (~$(round(DURATION_SECONDS/60, digits=1)) minutes)")
    println("  Batch size:     $(BATCH_SIZE) colors")
    println("  Report every:   $(REPORT_INTERVAL) seconds")
    println("  Seed:           $(SEED)")
    println("â•" ^ 60)
    println()
    
    start_time = time()
    last_report = start_time
    
    total_interactions = 0
    total_colors = 0
    mismatches = 0
    
    interaction = 0
    
    while (time() - start_time) < DURATION_SECONDS
        interaction += 1
        
        # Generate batch from two independent runs with interaction-specific seed
        seed_i = SEED + interaction
        
        colors1 = ka_colors(BATCH_SIZE, seed_i)
        colors2 = ka_colors(BATCH_SIZE, seed_i)
        
        fp1 = xor_fingerprint(colors1)
        fp2 = xor_fingerprint(colors2)
        
        if fp1 != fp2
            mismatches += 1
            println("  âŒ Mismatch at interaction $interaction!")
            println("     Fingerprint 1: $(string(fp1, base=16))")
            println("     Fingerprint 2: $(string(fp2, base=16))")
        end
        
        total_interactions += 1
        total_colors += BATCH_SIZE * 2
        
        # Progress report
        elapsed = time() - start_time
        if (time() - last_report) >= REPORT_INTERVAL
            remaining = DURATION_SECONDS - elapsed
            rate = total_colors / elapsed
            
            println("  [$(round(Int, elapsed))s/$(DURATION_SECONDS)s] " *
                    "$(total_interactions) interactions, " *
                    "$(round(total_colors/1e6, digits=1))M colors, " *
                    "$(round(rate/1e6, digits=1)) M/s, " *
                    "$(mismatches) mismatches")
            
            last_report = time()
        end
    end
    
    # Final report
    elapsed = time() - start_time
    rate = total_colors / elapsed
    
    println()
    println("â•" ^ 60)
    println("  VERIFICATION COMPLETE")
    println("â•" ^ 60)
    println("  Duration:        $(round(elapsed, digits=1)) seconds")
    println("  Interactions:    $(total_interactions)")
    println("  Total colors:    $(round(total_colors/1e6, digits=1))M")
    println("  Rate:            $(round(rate/1e6, digits=1)) M/s")
    println("  Mismatches:      $(mismatches)")
    println()
    
    if mismatches == 0
        println("  âœ“ ALL $(total_interactions) INTERACTIONS MATCH")
        println("  âœ“ Strong Parallelism Invariance verified for $(round(elapsed/60, digits=1)) minutes")
        println()
        return true
    else
        println("  âŒ $(mismatches) MISMATCHES DETECTED")
        println("  âŒ SPI verification FAILED")
        println()
        return false
    end
end

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Main
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if !verify_extended()
    exit(1)
end
